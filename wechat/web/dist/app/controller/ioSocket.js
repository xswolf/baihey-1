define(["app/module","app/directive/directiveApi","app/service/serviceApi","comm"],function(e){e.controller("message.chat1",["app.serviceApi","$scope","$timeout","$ionicPopup","$ionicModal","$ionicActionSheet","$ionicLoading","$ionicScrollDelegate","FileUploader","$http","$location","$rootScope","$filter","$ionicPopover","$interval","dataFilter",function(e,t,s,i,o,a,r,n,c,d,l,u,f,h,m,p){var v=ar.getCookie("bhy_user_id");t.historyList=[],t.blackList=!1,t.setMessageStatus=function(e){for(var t in e)4!=e[t].status&&(e[t].status=1);return e},t.sendId=ar.getCookie("bhy_user_id"),t.receiveId=l.search().id,t.blackListAlert=function(){return p.data.blacked.indexOf(t.receiveId)>-1?void ar.saveDataAlert(i,"您已被对方拉黑，不可查看对方资料。"):void(t.receiveId>=1e4?l.url("/userInfo?userId="+t.receiveId):l.url("/admin_info?userId="+t.receiveId))},e.list("/wap/member/honesty-photo",{user_id:t.receiveId}).success(function(e){t.sfzCheck=e.sfz}),t.hideMultiOnKeyboard=function(){angular.element(document.querySelector("#multi_con")).css("bottom","-110px"),angular.element(document.querySelector("#msg_footer_bar")).css("bottom","0")};var g=n.$getByHandle("messageDetailsScroll");t.messageNum=0;var y=ar.getStorage("chat_messageHistory-"+t.receiveId+"-"+v);for(var _ in y)3==y[_].status&&(y[_].status=4);t.doRefresh=function(){if(null!=y){var e=20,i=y.length;t.messageNum+=e;var o=i-t.messageNum<=0?0:i-t.messageNum;t.historyList=y.slice(o,i)}s(function(){t.$broadcast("scroll.refreshComplete")},1e3)},t.doRefresh(),window.addEventListener("native.keyboardshow",function(e){g.scrollBottom(!0)}),t.isLongTime=function(e,s){return 1>s?!0:e?e-t.historyList[s-1].create_time>300:!1},t.followData={},t.followData.user_id=t.sendId,t.followData.follow_id=t.receiveId,t.u_isFollow=!0,e.getStatus("/wap/follow/get-follow-status",t.followData).success(function(e){e.data&&(t.u_isFollow=!1)}),t.addFollow=function(){return t.followData.user_id==t.followData.follow_id?void ar.saveDataAlert(i,"您不能关注自己"):-1!=p.data.blacked.indexOf(t.followData.follow_id)?void ar.saveDataAlert(i,"对方设置，关注失败"):void e.save("/wap/follow/add-follow",t.followData).success(function(e){e.data&&(t.u_isFollow=!1,ar.saveDataAlert(i,"加关注成功"))})};var I=ar.getStorage("messageList-"+v);for(var _ in I)t.receiveId==I[_].id&&(t.auth_validate=I[_].auth.identity_check);t.real_name=l.search().real_name,t.sex=l.search().sex,t.age=l.search().age,t.report_flag=l.search().report_flag,t.receiveHeadPic=l.search().head_pic.replace(/~2F/g,"/"),t.sendHeadPic=JSON.parse(ar.getStorage("userInfo").info).head_pic,e.getUserInfo(t.receiveId).success(function(e){u.receiveUserInfo=e.data}),e.list("/wap/message/message-history",{id:t.receiveId}).success(function(e){var o=e.data.messageList;u.historyListHide=y=null!=y?y.concat(o):o,ar.setStorage("chat_messageHistory-"+t.receiveId+"-"+v,y),(o.length>0||0==e.data.status)&&(y=t.setMessageStatus(y)),ar.initPhotoSwipeFromDOM(".bhy-gallery",t,i),s(function(){g.scrollBottom(!0)},800)}).error(function(){console.log("页面message.js出现错误，代码：/wap/chat/message-history")}),t.uploader=new c({url:"/wap/file/thumb"}),f("orderBy")(),requirejs(["chat/wechatInterface","plugin/socket/socket.io.1.4.0"],function(e,s){s=s.connect("http://120.76.84.162:8088"),s.emit("tell name",{send_user_id:t.sendId,receive_user_id:t.receiveId,status:1}),t.$on("$destroy",function(){s.emit("tell name",{send_user_id:t.sendId,receive_user_id:t.receiveId,status:0}),s.disconnect()}),t.sendMessage=function(e,i,o,a,r,n){void 0!=r?"":r=ar.timeStamp();var c=ar.getId(t.historyList),d={id:c,message:e,send_user_id:i,receive_user_id:o,type:a,status:3,time:r,create_time:r};return p.data.blacked.indexOf(o)>-1?(d.refuse=-1,d.status=4,t.historyList.push(d),void ar.setStorage("chat_messageHistory-"+o+"-"+v,t.historyList)):((n&&"pic"!=a||"pic"==a&&!n)&&(t.historyList.push(d),ar.setStorage("chat_messageHistory-"+o+"-"+v,t.historyList)),void((n||"pic"!=a)&&s.emit("chat message",d)))},t.send=function(){if(""!=t.send_content&&null!=t.send_content&&void 0!=t.send_content){if(!t.userInfo.phone||"0"==t.userInfo.phone){var e=i.alert({template:"绑定手机，免费畅聊",okText:"现在去绑定"});return void e.then(function(e){l.url("/member/bindPhone")})}if(t.userInfo.id==l.$$search.id)return void ar.saveDataAlert(i,"您不能与自己聊天！");try{t.sendMessage(t.send_content,t.sendId,t.receiveId,"send",void 0,!0)}catch(s){}finally{t.send_content=""}}},t.send_pic=function(){var e=document.getElementById("pic_fileInput"),s=document.createEvent("MouseEvents");s.initEvent("click",!0,!0),e.dispatchEvent(s),t.uploader.filters.push({name:"file-size-Res",fn:function(e){return e.size>8388608?(ar.saveDataAlert(i,"请选择小于8MB的图片！"),!1):!0}});var o=ar.timeStamp();t.uploader.onAfterAddingFile=function(e){console.log(e),t.sendMessage(e.file.name,t.sendId,t.receiveId,"pic",o,!1),e.upload(),g.resize(),g.scrollBottom(!0),t.uploader.onSuccessItem=function(e,s,i,o){if(1==s.status)for(var a in t.historyList)t.historyList[a].message==e.file.name&&t.sendMessage(s.thumb_path,t.sendId,t.receiveId,"pic",t.historyList[a].time,!0);else for(var a=t.historyList.length-1;a>=0;a++)if("pic"==t.historyList[a].type&&3==t.historyList[a].status){t.historyList[a].status=4;break}}},t.uploader.onCompleteItem=function(e,s,o,a){if(s.thumb_path){var r=new Image;r.src=s.thumb_path,r.complete?(g.resize(),g.scrollBottom(!0)):r.onload=function(){g.resize(),g.scrollBottom(!0),r.onload=null},ar.initPhotoSwipeFromDOM(".bhy-gallery",t,i)}},t.uploader.onErrorItem=function(e,s,o,a){ar.saveDataAlert(i,"发送图片出错，错误原因未知");for(var r=t.historyList.length-1;r>=0;r++)if("pic"==t.historyList[r].type&&3==t.historyList[r].status){t.historyList[r].status=4;break}}},s.on(t.sendId+"-"+t.receiveId,function(e){if("10086"==e)return t.historyList=t.setMessageStatus(t.historyList),ar.setStorage("chat_messageHistory-"+t.receiveId+"-"+v,t.historyList),void t.$apply();var s=function(e){if("madd"!=e.type&&"remove"!=e.type&&"add"!=e.type){if(e.message=e.message.replace(/&quot;/g,'"'),t.sendId==e.send_user_id)for(var s in t.historyList)e.time!=t.historyList[s].time||e.message!=t.historyList[s].message&&"pic"!=e.type||(t.historyList[s].message=e.message,t.historyList[s].status=e.status);else if(e.id=ar.getId(t.historyList),t.historyList.push(e),"pic"==e.type){var i=new Image;i.src=e.message,i.complete?(g.resize(),g.scrollBottom(!0)):i.onload=function(){g.resize(),g.scrollBottom(!0),i.onload=null}}u.historyList=t.historyList,ar.setStorage("chat_messageHistory-"+t.receiveId+"-"+v,t.historyList),u.historyListHide=t.historyList,y=t.historyList}};switch(e.type){case"record":break;default:s(e),g.resize(),g.scrollBottom(!0),t.$apply()}})})}])});